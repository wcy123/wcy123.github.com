<html>
  <head>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
         m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
           })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-98267158-1', 'auto');
    ga('send', 'pageview');

    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      "HTML-CSS": {
      preferredFont: "STIX"
      },
      CommonHTML: {
      scale: 100
      },
      tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']]
      }});
</script>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>C Preprocessor tricks</title>

  <link rel="stylesheet" href="../writ.min.css">
</head>
<body>
<main>
<header>
<h1>C Preprocessor tricks</h1>
<h3 class="date">2015/06/01 09:38:40</h3>
</header>
<article>
<p>In this blog, I will show some examples about advanced C Preprocessor examples. First of all, I would say CPP macros are ugly, hard to debug and error prone.</p>
<h2 id="define-a-list-of-items">define a list of items</h2>
<p>I would like to use an example to illustrate the idea behind it. For example, I would like to implementat a set of unix command as below</p>
<p>{% highlight c %} #define CMD(XX) XX(ls) XX(cp) XX(rm) XX(echo) {% endhighlight %}</p>
<p>Then I could be able to write a common template function as below.</p>
<p>{% highlight c %} #define DEFINE_COMMON_TEMPLATE(name)<br />
void name()<br />
{<br />
printf(#name &quot; is not implemented&quot;);<br />
}</p>
<p>CMD(DEFINE_COMMON_TEMPLATE) {% endhighlight %}</p>
<p>It will expanded to</p>
<p>{% highlight c %} void ls () { printf (&quot;ls&quot; &quot; is not implemented&quot;); }</p>
<p>void cp () { printf (&quot;cp&quot; &quot; is not implemented&quot;); } // ... {% endhighlight %}</p>
<p>In the <code>main</code> function, we can use the similiar trick, as below</p>
<p>{% highlight c %} #define COMMAND_SWITCH(name)<br />
if (strcmp(argv[1], #name) == 0){<br />
name();<br />
} else CMD(COMMAND_SWITCH) { printf(&quot;unknown commmand %s&quot;, argv[1]); } {% endhighlight %}</p>
<p>And it will expanded into</p>
<p>{% highlight c %} if (strcmp (argv[1], &quot;ls&quot;) == 0) { ls (); } else if (strcmp (argv[1], &quot;cp&quot;) == 0) { cp (); } else if (strcmp (argv[1], &quot;rm&quot;) == 0) { rm (); } else if (strcmp (argv[1], &quot;echo&quot;) == 0) { echo (); } else { printf (&quot;unknown commmand %s&quot;, argv[1]); } {% endhighlight %}</p>
<p>The whole program is listed here.</p>
<p>{% highlight c %} #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;assert.h&gt;</p>
<h1 id="define-cmdxx-xxls-xxcp-xxrm-xxecho">define CMD(XX) XX(ls) XX(cp) XX(rm) XX(echo)</h1>
<h1 id="define-define_common_templatename-void-name-printfname-is-not-implemented">define DEFINE_COMMON_TEMPLATE(name)<br />
void name()<br />
{<br />
printf(#name &quot; is not implemented&quot;);<br />
}</h1>
<p>CMD(DEFINE_COMMON_TEMPLATE)</p>
<p>int main(int argc, char *argv[]) { #define COMMAND_SWITCH(name)<br />
if (strcmp(argv[1], #name) == 0){<br />
name();<br />
} else</p>
<pre><code>CMD(COMMAND_SWITCH) {
    printf(&quot;unknown commmand %s\n&quot;, argv[1]);
}
return 0;</code></pre>
<p>} {% endhighlight %}</p>
<h2 id="get-the-number-of-varadic-argument">get the number of varadic argument</h2>
<p>{% highlight c %} #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;assert.h&gt; #define _GET_N_OF_ARGS(_0,_1,_2,_3,_4,N,...) N #define N_OF_ARGS(...) _GET_N_OF_ARGS(<strong>VA_ARGS</strong>,5,4,3,2,1,0) int main(int argc, char *argv[]) { printf(&quot;%d&quot;, N_OF_ARGS(a)); printf(&quot;%d&quot;,N_OF_ARGS(a,b)); printf(&quot;%d&quot;,N_OF_ARGS(a,b,c)); printf(&quot;%d&quot;,N_OF_ARGS(a,b,c,d)); printf(&quot;%d&quot;,N_OF_ARGS(a,b,c,d,e)); return 0; } {% endhighlight %}</p>
<p><code>N_OF_ARGS</code> can handle at most 5 arguments and at least 1, otherwise, it is unpredictable error.</p>
<p>{% highlight c %} int main(int argc, char *argv[]) { printf(&quot;%d&quot;,1); printf(&quot;%d&quot;,2); printf(&quot;%d&quot;,3); printf(&quot;%d&quot;,4); printf(&quot;%d&quot;,5); return 0; } {% endhighlight %}</p>
<p>But {% highlight c %} N_OF_ARGS() // =&gt; _GET_N_OF_ARGS(,5,4,3,2,1) // =&gt; 1 printf(&quot;%d&quot;,N_OF_ARGS(a,b,c,d,e,f)); // =&gt; _GET_N_OF_ARGS(a,b,c,d,e,f) // =&gt; f {% endhighlight %}</p>
<h2 id="get-the-nth-element-of-arguments">get the nth element of arguments</h2>
</article>
</main>
</body>
</html>
