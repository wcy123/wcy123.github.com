<html>
  <head>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      "HTML-CSS": {
      preferredFont: "STIX"
      },
      CommonHTML: {
      scale: 100
      },
      tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']]
      }});
</script>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>bug: muc 用户无法发送消息</title>

  <link rel="stylesheet" href="../writ.min.css">
</head>
<body>
<main>
<header>
<h1>bug: muc 用户无法发送消息</h1>
<h3 class="date">2015/08/22 19:47:39</h3>
</header>
<article>
<h2 id="现象某一个用户无法发送消息在某一个群中无法发送消息">现象，某一个用户无法发送消息，在某一个群中无法发送消息。</h2>
<p>todo: 详细描述</p>
<p>出现错误</p>
<pre><code>ErrText = &lt;&lt;&quot;Traffic rate limit is exceeded&quot;&gt;&gt;,</code></pre>
<p>参考源代码 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L188-#L188">ErrText = &lt;&lt;&quot;Traffic rate limit is exceeded&quot;&gt;&gt;,</a></p>
<h2 id="log">log</h2>
<pre><code>{
  {39272943,{&lt;&lt;&quot;admin&quot;&gt;&gt;,&lt;&lt;&quot;easemob.com&quot;&gt;&gt;,&lt;&lt;&gt;&gt;}},
  {1,-1440143462487131},
  {activity,1440143462087100,0,none,none,undefined,undefined},
  nil,
  { {94388844,
    {&lt;&lt;&quot;ppcall#ppcall_101158266&quot;&gt;&gt;,&lt;&lt;&quot;easemob.com&quot;&gt;&gt;,
     &lt;&lt;&quot;mobile&quot;&gt;&gt;}},
   {0,0},
   {activity,1440070079048666,1440142077395191,none,none,
    {xmlel,&lt;&lt;&quot;message&quot;&gt;&gt;,
     [{&lt;&lt;&quot;id&quot;&gt;&gt;,&lt;&lt;&quot;96658737414013512&quot;&gt;&gt;},
      {&lt;&lt;&quot;to&quot;&gt;&gt;,&lt;&lt;&quot;ppcall#ppcall_89091123775013296@&quot;&gt;&gt;},
      {&lt;&lt;&quot;type&quot;&gt;&gt;,&lt;&lt;&quot;groupchat&quot;&gt;&gt;}],
     [{xmlel,&lt;&lt;&quot;body&quot;&gt;&gt;,
       [],
       [{xmlcdata,&lt;&lt;&quot;\&quot;{\&quot;from\&quot;:\&quot;101\&quot;&quot;&gt;&gt;}]},
      {xmlel,&lt;&lt;&quot;roomtype&quot;&gt;&gt;,
       [{&lt;&lt;&quot;xmlns&quot;&gt;&gt;,&lt;&lt;&quot;easemob:x:ro&quot;&gt;&gt;},
        {&lt;&lt;&quot;type&quot;&gt;&gt;,&lt;&lt;&quot;chatroom&quot;&gt;&gt;}],
       []}]},
    undefined},
   { {80817504,
     {&lt;&lt;&quot;ppcall#ppcall_104423680&quot;&gt;&gt;,&lt;&lt;&quot;easemob.com&quot;&gt;&gt;,
      &lt;&lt;&quot;mobile&quot;&gt;&gt;}},
    {0,0},
    {activity,1439978350380823,1440101296470696,none,none,
     {xmlel,&lt;&lt;&quot;message&quot;&gt;&gt;,
      [{&lt;&lt;&quot;id&quot;&gt;&gt;,&lt;&lt;&quot;96265465805930964&quot;&gt;&gt;},
       {&lt;&lt;&quot;to&quot;&gt;&gt;,&lt;&lt;&quot;ppcall#ppcall_89&quot;&gt;&gt;},
       {&lt;&lt;&quot;type&quot;&gt;&gt;,&lt;&lt;&quot;groupchat&quot;&gt;&gt;}],
      [{xmlel,&lt;&lt;&quot;body&quot;&gt;&gt;,[],[{xmlcdata,...}]},
       {xmlel,&lt;&lt;&quot;roomtype&quot;&gt;&gt;,[{&lt;&lt;&quot;...&quot;&gt;&gt;},{}],[]}]},
     undefined},
    nil,nil}}}</code></pre>
<p>分析：</p>
<p>某一用户 Activity 数据出现不一致。</p>
<ol style="list-style-type: decimal">
<li>用户有待发数据 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L187-#L187">Activity#activity.message /= undefined</a></li>
<li>但此时 <code>mod_muc_room:state</code> 队列为空，TODO 这里需要确认。</li>
</ol>
<h2 id="程序逻辑分析">程序逻辑分析</h2>
<ol style="list-style-type: decimal">
<li><p>用户消息到达数据 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L166-#L171">normal_state({route,.From,.&lt;&lt;&quot;&quot;&gt;&gt;,.#xmlel{name.=.&lt;&lt;&quot;message&quot;&gt;&gt;,.attrs.=.Attrs,.children.=.Els}.=.Packet},.StateData).-&gt;.</a></p></li>
<li><p>用户为普通用户 ，判断用户是否过于频繁发送消息，</p></li>
<li>用户没有过于频繁发送消息 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L194-#L197">.Now.&gt;=.Activity#activity.message_time.+.MinMessageInterval,.MessageShaperInterval.==.0.-&gt;.</a>
<ol style="list-style-type: decimal">
<li>如果队列为空 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L201-#L201">RoomShaperInterval == 0, RoomQueueEmpty</a> 则直接投递消息，<a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L211-#L211">process_groupchat_message</a>， room shaper 为 none ，todo 需要确认。</li>
<li>如果队列不空，把消息放入队列，<a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L227-#L227">RoomQueue = queue:in({message, From},</a> 设置消息到达时间 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L222-#L223">message_time.=.Now,</a> ，等待以后队列处理，<a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L217-#L217">process_room_queue</a>。 从 log 上看，代码一定经过了这个分支。</li>
</ol></li>
<li>用户过于频繁发送消息，<a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L236-#L237">true.-&gt;.MessageInterval.=.(Activity#activity.message_time.+</a>
<ol style="list-style-type: decimal">
<li>把用户消息置位 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L245-#L245">message = Packet</a> 。</li>
<li>过一段时间再处理用户消息 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L244-#L244">process_user_message</a></li>
</ol></li>
<li><p><code>process_user_message</code> 的流程分析 、<a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L780-#L781">handle_info({process_user_message, From},</a></p></li>
</ol>
<p>把消息放入队列，等待下次处理，<a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L784-#L784">RoomQueue = queue:in({message, From},</a>。</p>
<ol start="2" style="list-style-type: decimal">
<li><a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L792-#L792">handle_info(process_room_queue,</a> 消息队列处理流程。</li>
</ol>
<p>重置用户消息标记，<a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L798-#L798">NewActivity = Activity#activity{message = undefined},</a>。</p>
<p>现象上看，是用户消息标志 <code>activity.message</code> 没有重置，而且消息队列里面 又没有对应的消息，那么用户的消息标志就不会得到重置的机会。</p>
<p>目前的难点，本地无法重现这个错误。bug 发生概率不高。只要 <a href="https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/mod_muc_room.erl#L243-#L245">erlang:send_after(Interval,.self(),.{process_user_message,.From}),.</a> 保证</p>
<ol style="list-style-type: decimal">
<li><code>Interval</code> 毫秒之后，一定会向进程发送消息。</li>
<li>erlang VM 保证 <code>process_user_message</code> 消息不会丢失</li>
</ol>
<p>从官方文档上，没有看到关于 <code>send_after</code> 的详细描述，不知道是否可以保证以上两点。<a href="http://www.erlang.org/doc/man/erlang.html#send_after-4">参考官方文档</a></p>
</article>
</main>
</body>
</html>
