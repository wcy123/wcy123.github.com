<html>
  <head>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      "HTML-CSS": {
      preferredFont: "STIX"
      },
      CommonHTML: {
      scale: 100
      },
      tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']]
      }});
</script>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
</script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>ZFS 转移数据</title>

  <link rel="stylesheet" href="../writ.min.css">
</head>
<body>
<main>
<header>
<h1>ZFS 转移数据</h1>
<h3 class="date">2015/07/10 16:40:38</h3>
</header>
<article>
<p>我以前有一个旧的磁盘阵列，用 zfs 系统，现在想把数据导入到新的系统里面。</p>
<p>数据传输速度很慢，下面这个链接很有帮助。</p>
<p>http://everycity.co.uk/alasdair/2010/07/using-mbuffer-to-speed-up-slow-zfs-send-zfs-receive/</p>
<p>安装 freenas 上的 mbuffer http://unquietwiki.blogspot.in/2015/01/mbuffer-on-freenas-sending-recursive.html</p>
<p>在目标机器上运行服务器。</p>
<pre><code>[root@freenas2] ~# mbuffer -s 128k -m 3G -4 -I 9090 | zfs recv -v -F mypool/export</code></pre>
<p>在源机器上运行客户端。</p>
<pre><code>zfs snapshot -R create balbagvaba
c1@file1:~$ sudo zfs send -R mypool/export@20150708 | mbuffer -s 128k -m 1G -O 192.168.0.114:9090
</code></pre>
<p>查看系统瓶颈</p>
<pre><code>top -SH
gstat</code></pre>
<p>NFS 共享</p>
<p>freeNAS 没有使用 ZFS 的 NFS 共享，而是 freebsd 自带的 NFS 共享。修改 <code>/etc/exports</code> ，或者用图形界面。我的列表比较长，很容易用命令处理。</p>
<pre><code>/mnt/mypool/export/prod
/mnt/mypool/export/cluster-root -maproot=root</code></pre>
<p>参考 https://www.freebsd.org/doc/handbook/network-nfs.html</p>
<p>修改完了之后，运行</p>
<pre><code>service mountd reload</code></pre>
<p>查看是否生效</p>
<pre><code>showmount -e localhost</code></pre>
</article>
</main>
</body>
</html>
