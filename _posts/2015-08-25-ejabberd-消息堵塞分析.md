---
layout: post
title:  "ejabberd 消息堵塞分析"
date:   2015/08/25 14:27:55
categories:
comments: true
draft: true
---

## log 构建 11431 (2015-8-25 11:47:00)

log 位置 ()[http://ci.easemob.com/view/ProductionCI/job/ProductCI_ejabberd_mqueue_random_monitor_dbcluster/11431/console]

### log 信息

<pre>
c("/opt/ejabberd/monitor.erl"), monitor:longest_mq()
processes sorted by queue_len desc:
 [{<6555.12.0>,{message_queue_len,<span style="color:red;">1511</span>}},
  {<6555.4233.0>,{message_queue_len,<span style="color:red">807</span>}},
  {<6555.4232.0>,{message_queue_len,<span style="color:red">807</span>}},
  {<6555.32681.79>,{message_queue_len,260}},
  {<6555.32553.79>,{message_queue_len,260}},
  {<6555.32220.4479>,{message_queue_len,0}},
  {<6555.4560.4527>,{message_queue_len,0}},
  {<6555.18676.5966>,{message_queue_len,0}},
  {<6555.11484.6350>,{message_queue_len,0}},
  {<6555.8362.5822>,{message_queue_len,0}}]
</pre>

进程 `<6555.12.0>` 有 1151 个消息没有处理。

头20个为处理的消息是

<pre>
[{'$gen_call',{<7091.32103.5792>,#Ref<7091.0.87991.137462>},
               {call,mnesia_lib,db_get,
                     [session_frag29,
                      {<<"intech#in_0ciaqmflhdzybo">>,<<"easemob.com">>,
                       <<"mobile">>}],
                     <7089.3018.0>}},
  {'$gen_call',{<7092.14074.2311>,#Ref<7092.0.73855.182955>},
               {call,<span style="color:red">mnesia_lib,db_get,</span>
                     [<span style="color:red">session_frag29,</span>
                      {<<"intech#in_0ciha2edkdvzbi">>,<<"easemob.com">>,
                       <<"mobile">>}],
                     <7089.3018.0>}},
  {<6555.211.8072>,{reply,ok}},
  {<6555.1482.8072>,{reply,ok}},
  {<6555.945.8072>,{reply,ok}},
  {'$gen_call',{<7093.15399.2998>,#Ref<7093.0.20948.155361>},
               {call,mnesia,activity,
                     [async_dirty,#Fun<mnesia.select.2>,
                      [session,
                       [{ {session,'_','$1',
                                  {<<"intech#in_0cyhagelgdr3ry">>,
                                   <<"easemob.com">>},
                                  '_','_'},
                         [{'/=',as_partial_key,
                                { {<<"intech#in_0cyhagelgdr3ry">>,
                                  <<"easemob.com">>}}}],
                         ['$1']}]],
                      mnesia_frag],
                     <7093.3294.0>}},
  {<6555.2535.8072>,{reply,ok}},
  {<6555.411.8072>,{reply,[{ {1440,474421,964666},<7098.8910.2093>}]}},
  {<6555.3401.8072>,{reply,[]}},
  {<6555.32475.8071>,{reply,[]}}]
</pre>

代码搜索关键字 `session_frag` 找到唯一匹配的地方 [frag_name(N) -> list_to_atom("session_frag"++integer_to_list(N))..](https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/ejabberd_sm.erl#L1032-#L1034)。

`frag_name` 是 ejabberd_sm 的私有函数。唯一调用者是 [repair_frag(FragToFixNum, SeedFragNum) ->](https://github.com/easemob/ejabberd/blob/f2c2175defbe1a253e56ec37e2f361460e345e65/src/ejabberd_sm.erl#L1024-#L1024)。

期待调用调用函数是 `mnesia_lib:db_get`，

经过分析，觉得这个进程是 rpc 进程，由 application kernel 启动。因为进程号很小 12 。打开一个 erl， 都可以看到

```
my:ejabberd wangchunye$ erl
Erlang/OTP 17 [erts-6.4] [source] [64-bit] [smp:4:4] [async-threads:10] [hipe] [kernel-poll:false]

Eshell V6.4  (abort with ^G)
1> whereis(rex).
<0.12.0>
2>
```

`erlang/lib/kernel-3.2/src/rpc.erl:27` 可以看到 rpc 进程的名字是

```
-define(NAME, rex).
```

rpc.erl 分析

 - 本地呼叫，不需要建立多余进程

```
call(N,M,F,A) when node() =:= N ->  %% Optimize local call
    local_call(M, F, A);


local_call(M, F, A) when is_atom(M), is_atom(F), is_list(A) ->
    case catch apply(M, F, A) of
	{'EXIT',_}=V -> {badrpc, V};
	Other -> Other
    end.
```

验证


```
5> self().
<0.37.0>
6> rpc:call(node(),erlang,self,[]).
<0.37.0>
```

- 远程 rpc 呼叫，都是通过同一个进程 rex 处理，rex 立即启动一个新进程处理呼叫。

{% highlight erlang %}
do_call(Node, Request, Timeout) ->
    Tag = make_ref(),
    {Receiver,Mref} =
	erlang:spawn_monitor(
	  fun() ->
		  %% Middleman process. Should be unsensitive to regular
		  %% exit signals.
		  process_flag(trap_exit, true),
		  Result = gen_server:call({?NAME,Node}, Request, Timeout),
		  exit({self(),Tag,Result})
	  end),
    receive
	{'DOWN',Mref,_,_,{Receiver,Tag,Result}} ->
	    rpc_check(Result);
	{'DOWN',Mref,_,_,Reason} ->
	    %% The middleman code failed. Or someone did
	    %% exit(_, kill) on the middleman process => Reason==killed
	    rpc_check_t({'EXIT',Reason})
    end.
{% endhighlight %}

正常来讲，不应该出现 rex 进程消息堆积。

遗留问题，很难复现这种情况。


可以改进 monitor.erl, 打印系统信息。

下一步，增加系统其他信息的打印，包括进程数，进程限制，


## 27140 (2015-8-25 16:16:00)

[log](http://ci.easemob.com/view/ProductionCI/job/ProductCI_ejabberd_mqueue_random_monitor/27140/console)

```
processes sorted by queue_len desc:
 [{<6562.26699.4254>,{message_queue_len,10084}},
  {<6562.25972.4111>,{message_queue_len,3837}},
  {<6562.26669.4130>,{message_queue_len,49}},
  {<6562.17491.3482>,{message_queue_len,2}},
  {<6562.5764.0>,{message_queue_len,1}},
  {<6562.4089.0>,{message_queue_len,1}},
  {<6562.32766.3551>,{message_queue_len,0}},
  {<6562.32764.6687>,{message_queue_len,0}},
  {<6562.32747.3727>,{message_queue_len,0}},
  {<6562.32743.3135>,{message_queue_len,0}}]
  message queue len of pid <6562.26699.4254> : undefined
```

进程 4225 瞬间死亡了。无从了解堵在哪里了。


## 27044 (2015-8-25 11:28:00)

[log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/27044/console)

```
[{<6562.18467.5386>,{message_queue_len,12746}},
  {<6562.28990.4377>,{message_queue_len,3}},
  {<6562.7344.4596>,{message_queue_len,2}},
  {<6562.4071.0>,{message_queue_len,2}},
  {<6562.20132.1995>,{message_queue_len,1}},
  {<6562.16308.132>,{message_queue_len,1}},
  {<6562.32767.2591>,{message_queue_len,0}},
  {<6562.32766.2303>,{message_queue_len,0}},
  {<6562.32762.4335>,{message_queue_len,0}},
  {<6562.32754.4367>,{message_queue_len,0}}]
message queue len of pid <6562.18467.5386> : {message_queue_len,17118}
message in pid <6562.18467.5386> :
 [{p1_mysql_recv,<6562.29581.5794>,data,
                 <<13,122,104,105,109,113,35,122,104,105,109,113,95,50,30,122,
                   104,105,109,113,35,122,104,105,109,113,95,50,54,48,53,50,53,
                   64,101,97,115,101,109,111,98,46,99,111,109,0,1,66,1,78,0,1,
                   78,0,4,105,116,101,109>>,
                 26},
  {p1_mysql_recv,<6562.29581.5794>,data,
                 <<13,122,104,105,109,113,35,122,104,105,109,113,95,50,30,122,
                   104,105,109,113,35,122,104,105,109,113,95,51,51,54,52,54,50,
                   64,101,97,115,101,109,111,98,46,99,111,109,0,1,66,1,78,0,1,
                   78,0,4,105,116,101,109>>,
                   27},
                   ....
```

发送消息的位置，[Parent ! {p1_mysql_recv, self(), data, Packet, Num},](git://github.com/ericliang/mysql/blob/376b5ca5d611434d38cae83dd900b491fe19cad5/deps/p1_mysql/src/p1_mysql_recv.erl#L158-#L158)。

Parent 是谁呢？[Rest = sendpacket(State#state.parent, NewData),](git://github.com/ericliang/mysql/blob/376b5ca5d611434d38cae83dd900b491fe19cad5/deps/p1_mysql/src/p1_mysql_recv.erl#L128-#L128)

state.parent 是谁？有多少个进程在运行 [loop(State)](git://github.com/ericliang/mysql/blob/376b5ca5d611434d38cae83dd900b491fe19cad5/deps/p1_mysql/src/p1_mysql_recv.erl#L122-#L122) ?



## 25877 (2015-8-23 0:34:01)

[log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25877/console)

```
processes sorted by queue_len desc:
 [{<6562.25870.402>,{message_queue_len,3102}},
  {<6562.6042.0>,{message_queue_len,1}},
  {<6562.4635.0>,{message_queue_len,1}},
  {<6562.4132.0>,{message_queue_len,1}},
  {<6562.32763.559>,{message_queue_len,0}},
  {<6562.32758.1647>,{message_queue_len,0}},
  {<6562.32757.1279>,{message_queue_len,0}},
  {<6562.32757.1471>,{message_queue_len,0}},
  {<6562.32756.15>,{message_queue_len,0}},
  {<6562.32755.1535>,{message_queue_len,0}}]
message queue len of pid <6562.25870.402> : {message_queue_len,3102}
message in pid <6562.25870.402> :
 [{'$gen_event',
      {route,
          {jid,<<"snh-48#pocket48_51786">>,<<"easemob.com">>,<<"mobile">>,
              <<"snh-48#pocket48_51786">>,<<"easemob.com">>,<<"mobile">>},
          <<>>,
          {xmlel,<<"iq">>,
              [{<<"id">>,<<"G9sfS-121">>},
               {<<"to">>,
                <<"snh-48#pocket48_76366191207121304@conference.easemob.com">>}, 
               {<<"type">>,<<"get">>}],
              [{xmlel,<<"query">>,
                   [{<<"xmlns">>,<<"http://jabber.org/protocol/disco#info">>}],
                   []}]}}},
  {'$gen_event',
      {route,
          {jid,<<"snh-48#pocket48_51786">>,<<"easemob.com">>,<<"mobile">>,
              <<"snh-48#pocket48_51786">>,<<"easemob.com">>,<<"mobile">>},
          <<>>,
          {xmlel,<<"iq">>,
              [{<<"id">>,<<"G9sfS-123">>},
               {<<"to">>,
                <<"snh-48#pocket48_76366191207121304@conference.easemob.com">>}, 
               {<<"type">>,<<"get">>}],
              [{xmlel,<<"query">>,
                   [{<<"xmlns">>,<<"http://jabber.org/protocol/disco#info">>}],
                   []}]}}},
  {'$gen_event',
      {route,
          {jid,<<"snh-48#pocket48_51925">>,<<"easemob.com">>,<<"mobile">>,
              <<"snh-48#pocket48_51925">>,<<"easemob.com">>,<<"mobile">>},
          <<>>,
          {xmlel,<<"message">>,
              [{<<"id">>,<<"97407888556818844_WX9im-101-098df">>},
               {<<"to">>,
```

所有的 "to" 字段，都是 "snh-48#pocket48_76366191207121304@conference.easemob.com" ，表明是 `mod_muc_room` 进程阻塞住了。


## 25870 (2015-8-23 0:13:00)
[log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25870/console)
和上一个类似。

类似 `snh-48#pocket48_76366185993601452@conference.easemob.com`

## 25864 (2015-8-22 23:55:00)

类似， `snh-48#pocket48_76366191207121304@conference.easemob.com`。

## 25808 (2015-8-22 21:07:00)

类似 `"snh-48#pocket48_76366185259598244@conference.easemob.com"`


## 25781 (2015-8-22 19:46:01)

类似 `snh-48#pocket48_76366185259598244@conference.easemob.com`

## 25746 2015-8-22 18:04:00

类似  `snh-48#pocket48_76366185259598244@conference.easemob.com`


```
(ejabberd@ebs-ali-beijing-5-pri)1> muc_mnesia:rpc_get_online_room(<<"snh-48#pocket48_76366185259598244">>, <<"conference.easemob.com">>).
[{muc_online_room,{<<"snh-48#pocket48_76366185259598244">>,
                   <<"conference.easemob.com">>},
                   <19007.783.478>}]

```


# 从头分析

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/23101/console)

mysql

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/23469/console)

- "tusou001#v40_77605680705438120@conference.easemob.com"
- Pid = 6562.21505.3

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/23483/console)

- "tusou001#v40_77605680705438120@conference.easemob.com"
- Pid = 6562.21505.3

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/23747/console)

- Pid = 6562.2268.0
- Process dead before checking

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24119/console)

- Pid = 6562.21505.3
- "tusou001#v40_77605680705438120@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24143/console)

- Pid = 6562.21505.3
- "tusou001#v40_77605680705438120@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24170/console)

- Pid = 6562.21505.3
- "tusou001#v40_77605680705438120@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24228/console)

- Pid = 6562.18009.3390
- mysql

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24282/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24340/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24430/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24433/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/24719/console)

unknown

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25330/console)

- Pid 6562.25870.402
- "snh-48#pocket48_76366191207121304@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25341/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25394/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25731/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25746/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25781/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25808/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25846/console)

- Pid = 6562.783.478
- "snh-48#pocket48_76366185259598244@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25864/console)

- Pid = 6562.25870.402
- "snh-48#pocket48_76366191207121304@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25870/console)

- Pid - 6562.21911.478, "snh-48#pocket48_76366185993601452@conference.easemob.com"
- Pid - 6562.783.478 second "snh-48#pocket48_76366191207121304@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/25877/console)

- Pid - 6562.25870.402
- "snh-48#pocket48_76366191207121304@conference.easemob.com"

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/27044/console)

- Pid - 6562.18467.5386
- sql

## [log](http://ci.easemob.com/job/ProductCI_ejabberd_mqueue_random_monitor/27140/console)

- Pid - 6562.26699.4254
- Process dead before checking
- Pid 6562.25972.4111 is the second


有三个群出现过问题

1. "tusou001#v40_77605680705438120@conference.easemob.com" 出现 4 次
2. "snh-48#pocket48_76366185259598244@conference.easemob.com" 出现 11 次
3. "snh-48#pocket48_76366191207121304@conference.easemob.com" 出现 2 次
