---
layout: post
title:  "ejabberd 的启动过程"
date:   2015/07/30 15:21:02
categories:
draft: true
comments: false
---

## [ejabberd_logger:start()][1]

[1]: https://github.com/processone/ejabberd/blob/5a35405cd523127fcd051a38414529680b69505c/src/ejabberd_app.erl#L41

1. [加载 sasl](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L105)，还没有启动。
2. [启动 lage](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L128)
   - [替代 `sasl` 自己的 logger](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L106)
   - [设置 log 文件名称](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L54)

     ```
     可以用环境变量设置 log 文件名称。EJABBERD_LOG_PATH
     或者用命令行 erl -ejabberd log_path '"/var/log/ejabberd/"'
     会有 log 文件 error.log 和 crash.log 生成。

     ```
   - 设置 log 参数
      - [设置 log_rotate_date](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L112)
      - [设置 log_rotate_size](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L113)
      - [设置 log_rotate_count](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L114)
      - [设置 log_rate_limit](https://github.com/wcy123/ejabberd/blob/ab196b4b02ac2cbe7114ecb466cc10aea55bc112/src/ejabberd_logger.erl#L115)

      ```
      这些参数可以通过命令行设置 erl -ejabberd log_rotate_date 111
      ```

      问题：既然已经替代掉了，为啥还有一个条件编译 `LAGER` ，[参见这里](https://github.com/wcy123/ejabberd/blob/5a35405cd523127fcd051a38414529680b69505c/include/logger.hrl#L22)
      rebar 的配置文件已经默认定义这个宏了，[参见这里](https://github.com/wcy123/ejabberd/blob/b0453ea2ce8bf5078c345da4b7d8870d025976c2/rebar.config.script#L29)

## [写 pid 文件](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L211)

pid 文件由环境变量 [EJABBERD_PID_PATH](https://github.com/wcy123/ejabberd/blob/66310788848ef185f3831648b2abf67ab6ded7fa/src/ejabberd.erl#L54) 来控制，如果没有定义就不写。

## [start_apps](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L46)

1. [crypto](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L250) 正常 application
2. [sasl](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L251) 正常启动。`start_app` 可以自动处理依赖关系。
1. `p1_ssl`
0. `p1_yaml`
1. `p1_tls`
2. `p1_xml`
3. `p1_stringprep`
4. `p1_zlib`
5. `p1_cache_tab`

问题: `ejabberd_app:start_app` 中的参数 `Type` 似乎没有使用，似乎准备传递给 `application:start` 但是没有传递。不过默认参数也是 temporary 。[参考这里](https://github.com/wcy123/ejabberd/blob/66310788848ef185f3831648b2abf67ab6ded7fa/src/ejabberd.erl#L81).

StartFlag 似乎只是用来调试的，表明 ejabberd 是否已经加载。

问题：Erlang OTP 本身有处理依赖关系的功能，例如
application:get_key(App, applications) 可以查看依赖关系。利用这个功能，
整个 `ejabberd_app` 的功能都可以简化了，可读性也变好了。



除了处理依赖关系，`start_app` 还有一个功能，可以检查 app 相关的
modules 是否都已经加载了。相关的系统 API 有。

 -  `application:get_key(App, modules)`
 -  `code:which(Mod)`
 -  `code:lib_dir(Mod)`

## [ejabberd:check_app(ejabberd)](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L47)

这个就是 `ejabberd_app:start_app` 中的功能了。 [参考这里](https://github.com/wcy123/ejabberd/blob/66310788848ef185f3831648b2abf67ab6ded7fa/src/ejabberd.erl#L70)


## [db_init](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L49)

[初始化数据库](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L116)

问题：这里不支持动态进入 cluster ? cluster 可以自动变大变小。

问题：[可能是一个 bug](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L135) 因为 `ejabberd_app::start_app` 中没有使用 Type。提交了 pull request。

这里启动 mnesia。如果使用 OTP 自带的以来管理工具，applications 应该包含 mnesia。

## [start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L50)

[这里启动一个空循环的进程](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L109)

问题：`ejabberd:start/2` 和 `ejabberd:start/0` 完全不相关，这个有些怪异。


## [translate:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L51)

暂时忽略这个模块，用于支持多语言界面的功能。`EJABBERD_MSGS_PATH` 环境
变量在这里使用了。


## [ejabberd_ctl:init](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L52)

控制接口模块初始化。创建两个 ets 表格。

 - `ejabberd_ctl_cmds`
 - `ejabberd_ctl_host_cmds`

疑问：named_table, set, public 是不是 cluster level 还是 node level 的。


## [ejabberd_commands:init](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L53)

[创建表格](https://github.com/wcy123/ejabberd/blob/7ab6c4b4fd65d75e670152c38551d4311e1b481b/src/ejabberd_commands.erl#L228) `ejabberd_commands` 。

[表格格式](https://github.com/wcy123/ejabberd/blob/5a35405cd523127fcd051a38414529680b69505c/include/ejabberd_commands.hrl#L35)

TODO: 格式啥意思？

## [ejabberd_admin:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L54)

向表格 `ejabberd_commands`
[灌入](https://github.com/wcy123/ejabberd/blob/7ab6c4b4fd65d75e670152c38551d4311e1b481b/src/ejabberd_commands.erl#L235)
命令。


## [gen_mod:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L55)

[创建表格](https://github.com/wcy123/ejabberd/blob/9a9633dbc50430185a49cfda489bc87bed838d7c/src/gen_mod.erl#L63)
`ejabberd_modules` 。这个函数的名字不好，其实没有启动任何进程。


## [ejabberd_config:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L56)

[创建表格](https://github.com/wcy123/ejabberd/blob/76104cd117126a2ac8b20b2ddcce4ec6ff12004a/src/ejabberd_config.erl#L63)
`local_config` ，
[读取配置文件](https://github.com/wcy123/ejabberd/blob/76104cd117126a2ac8b20b2ddcce4ec6ff12004a/src/ejabberd_config.erl#L69)
，[写入刚刚创建的表格中](https://github.com/wcy123/ejabberd/blob/76104cd117126a2ac8b20b2ddcce4ec6ff12004a/src/ejabberd_config.erl#L82)

TODO: 单独一个页面描述参数系统的两个功能， macro 和 `include_config_file`。

## [set_settings_from_config](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L57)

 - [设置日志等级](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L242)
 - [net_kernel:set_net_ticktime](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L247) ， 默认 60 秒 ， 参考 [kernel](http://erlang.org/doc/man/kernel_app.html) 手册。

## [acl:start()](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L58)

[创建表格](https://github.com/wcy123/ejabberd/blob/fb6267f38ee47f3f725f88324d132741c85dfb6a/src/acl.erl#L73)
acl , access 。然后从配置文件初始化表格。

问题：创建这么多 `local_content` 的表格，为啥不用 ets ?



## [shaper:start()](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L59)

[创建表格](https://github.com/wcy123/ejabberd/blob/fb6267f38ee47f3f725f88324d132741c85dfb6a/src/shaper.erl#L53)
`shaper` ，[从配置文件灌入数据](https://github.com/wcy123/ejabberd/blob/fb6267f38ee47f3f725f88324d132741c85dfb6a/src/shaper.erl#L66)。


## [connect_nodes](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L60)

参数 `cluster_nodes` 控制的，[链接所有节点。](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L176)

问题：似乎不知道动态增加/删除节点？

如果可以支持这个功能，那么 cluster 就变成活的，只要有一个节点不死，
cluster 就可以慢慢长大。


## [Sup = ejabberd_sup:start_link](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L61)

这个需要单独一个页面描述。这个 supervisor 启动了好多东西。

## [ejabberd_rdbms:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L62)

参数 [odbc_type](https://github.com/wcy123/ejabberd/blob/fb6267f38ee47f3f725f88324d132741c85dfb6a/src/ejabberd_rdbms.erl#L76) 控制。

可以是
  - mysql
  - pgsql
  - sqlite
  - odbc
  - undefined


参数
[hosts](https://github.com/wcy123/ejabberd/blob/76104cd117126a2ac8b20b2ddcce4ec6ff12004a/src/ejabberd_config.erl#L787)
控制那些 hosts 需要 odbc.

[MYHOST](https://github.com/wcy123/ejabberd/blob/9b4942890d251bf8d8bb373984c8e441eafdd300/include/ejabberd.hrl#L26) 的定义。用的地方还挺多。


## [ejabberd_riak_sup:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L63)

有参数 [riak_server](https://github.com/wcy123/ejabberd/blob/c1119b1f3945a37f656934ef530f8c7bf158530f/src/ejabberd_riak_sup.erl#L61)
[riak_port](https://github.com/wcy123/ejabberd/blob/c1119b1f3945a37f656934ef530f8c7bf158530f/src/ejabberd_riak_sup.erl#L64)
[ejabberd_auth_riak](https://github.com/wcy123/ejabberd/blob/c1119b1f3945a37f656934ef530f8c7bf158530f/src/ejabberd_riak_sup.erl#L67) 或者 module 参数 [db_type](https://github.com/wcy123/ejabberd/blob/9a9633dbc50430185a49cfda489bc87bed838d7c/src/gen_mod.erl#L281) 控制。

启动 riakc 。


## [ejabberd_sm:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L64)

在 [ejabberd_sub](https://github.com/wcy123/ejabberd/blob/fb6267f38ee47f3f725f88324d132741c85dfb6a/src/ejabberd_sm.erl#L107) 增加 child 。

疑问，为啥不在 `ejabberd_sup` 中直接加 child spec 呢？有执行顺序问题？

## [cyrsasl:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L65)


[启动下面的东西](https://github.com/wcy123/ejabberd/blob/fb6267f38ee47f3f725f88324d132741c85dfb6a/src/cyrsasl.erl#L83) 这个也不是启动。因为没有创建任何近程。

  - [创建表格 sasl_mechanism](https://github.com/wcy123/ejabberd/blob/fb6267f38ee47f3f725f88324d132741c85dfb6a/src/cyrsasl.erl#L80)
  - `cyrsasl_plain`
  - `cyrsasl_digest`
  - `cyrsasl_scram`
  - `cyrsasl_anonymous`

## [maybe_add_nameservers](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L69)

没有用。

## [ext_mod:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L70)

启动扩展模块。


## [ejabberd_auth:start](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L71)

启动认证模块。


## [start_modules](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L72)

启动其他配置的模块

## [ejabberd_listener:start_listeners](https://github.com/wcy123/ejabberd/blob/dcf5aefea0363cc96d404591696e306fc323d8f5/src/ejabberd_app.erl#L73)

启动监听端口。
